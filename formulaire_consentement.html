<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Consentement à l'anesthésie</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: auto; padding: 20px; }
    h1 { text-align: center; color: #003366; }
    canvas { border: 1px solid black; width: 100%; height: 200px; touch-action: none; background: white; }
    button { margin-top: 10px; padding: 10px; background: #003366; color: white; border: none; cursor: pointer; }
    label { display: block; margin-top: 15px; }
    #controls { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Consentement éclairé à l'anesthésie</h1>
  <p><em>Aucun acte médical ne peut être pratiqué sans le consentement libre et éclairé de la personne (Article L. 1111-4 du Code de la santé publique).</em></p>
  <p><em>Votre intervention ne pourra avoir lieu en l'absence de signature de ce document. Le consentement ne constitue pas une décharge de responsabilité.</em></p>

  <label>Nom et prénom : <input type="text" id="nom"></label>
  <label>Date de naissance : <input type="date" id="naissance"></label>

  <label><input type="checkbox" name="item" value=""> 
    Je consens à bénéficier de l'acte d'anesthésie qui m'a été expliqué en consultation par le Docteur 
    <select id="medecin">
      <option value="">-- Choisir --</option>
      <option value="Alves">Alves</option>
      <option value="Ayoub">Ayoub</option>
      <option value="Bouferrache">Bouferrache</option>
      <option value="Cotillon">Cotillon</option>
      <option value="Daoud">Daoud</option>
      <option value="Deverre">Deverre</option>
      <option value="Lancrin">Lancrin</option>
      <option value="Lê Dinh">Lê Dinh</option>
      <option value="Lopes">Lopes</option>
      <option value="Martin">Martin</option>
      <option value="Mendy">Mendy</option>
      <option value="Sicard">Sicard</option>
    </select>.
  </label>

  <label><input type="checkbox" name="item" value="J'ai été informé des bénéfices attendus de l'anesthésie et de ses risques, fréquents et/ou graves."> J'ai été informé des bénéfices attendus de l'anesthésie et de ses risques, fréquents et/ou graves.</label>

  <label><input type="checkbox" name="item" value="Le Médecin Anesthésiste-Réanimateur m'a donné l'opportunité de poser mes questions relatives à l'anesthésie."> Le Médecin Anesthésiste-Réanimateur m'a donné l'opportunité de poser mes questions relatives à l'anesthésie.</label>

  <label><input type="checkbox" name="item" value="Je consens à tout changement de technique nécessaire pour la sécurité de mes soins."> Je consens à tout changement de technique nécessaire pour la sécurité de mes soins.</label>

  <label>Signature :</label>
  <canvas id="signature-pad" width="600" height="200"></canvas>

  <label>Date <input type="text" id="date" readonly></label>

  <div id="controls">
    <button onclick="clearSignature()">Effacer la signature</button>
    <button onclick="envoyer()">Envoyer au médecin</button>
  </div>

  <script>
    const canvas = document.getElementById('signature-pad');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    canvas.addEventListener('mousedown', e => startDrawing(e.offsetX, e.offsetY));
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    canvas.addEventListener('mousemove', e => draw(e.offsetX, e.offsetY));

    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      startDrawing(touch.clientX - rect.left, touch.clientY - rect.top);
    });

    canvas.addEventListener('touchend', stopDrawing);
    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      draw(touch.clientX - rect.left, touch.clientY - rect.top);
    });

    function startDrawing(x, y) {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function draw(x, y) {
      if (!drawing) return;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function stopDrawing() {
      drawing = false;
    }

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    document.getElementById('date').value = new Date().toISOString().split('T')[0];

    async function envoyer() {
      const nom = document.getElementById("nom").value;
      const naissance = document.getElementById("naissance").value.split("-").reverse().join("-");
      const medecin = document.getElementById("medecin").value;
      const date = document.getElementById("date").value;
      const signature = canvas.toDataURL("image/png");
      const checkboxes = document.querySelectorAll("input[name='item']");
      const items = [];

      checkboxes.forEach((box, index) => {
        if (box.checked) {
          if (index === 0) {
            items.push("Je consens à bénéficier de l'acte d'anesthésie qui m'a été expliqué en consultation par le Docteur " + medecin + ".");
          } else {
            items.push(box.value);
          }
        }
      });

      const data = { nom: nom + " (né le " + naissance + ")", date, signature, items };

      const response = await fetch("http://consentement.onrender.com/envoyer-consentement/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      alert(result.message || result.error);
    }
  </script>
</body>
</html>
